<?php

namespace App\UseCases\Asset;

use App\Exceptions\VulnerabilityAlreadyAttachedException;
use App\Repositories\Contracts\AssetRepositoryInterface;
use App\Repositories\Contracts\VulnerabilityRepositoryInterface;
use Illuminate\Database\Eloquent\ModelNotFoundException;

final readonly class AttachVulnerabilityUseCase
{
    public function __construct(
        protected AssetRepositoryInterface $assetRepository,
        protected VulnerabilityRepositoryInterface $vulnerabilityRepository,
    ) {
    }

    /** @throws VulnerabilityAlreadyAttachedException */
    public function execute(int $assetId, string $cveId): void
    {
        $asset = $this->assetRepository->find($assetId);

        if (is_null($asset)) {
            throw new ModelNotFoundException('Asset not found');
        }

        $vulnerability = $this->vulnerabilityRepository->findByCve($cveId);

        if (is_null($vulnerability)) {
            throw new ModelNotFoundException('Vulnerability not found');
        }

        $this->assetRepository->attachVulnerability($assetId, $vulnerability->id);
    }
}
