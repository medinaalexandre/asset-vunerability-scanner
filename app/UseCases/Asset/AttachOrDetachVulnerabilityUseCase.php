<?php

namespace App\UseCases\Asset;

use App\Events\VulnerabilityRelatedToAsset;
use App\Exceptions\VulnerabilityAlreadyAttachedException;
use App\Repositories\Contracts\AssetRepositoryInterface;
use App\Repositories\Contracts\VulnerabilityRepositoryInterface;
use Illuminate\Database\Eloquent\ModelNotFoundException;

abstract class AttachOrDetachVulnerabilityUseCase
{
    public function __construct(
        protected AssetRepositoryInterface $assetRepository,
        protected VulnerabilityRepositoryInterface $vulnerabilityRepository,
    ) {
    }

    /** @throws VulnerabilityAlreadyAttachedException */
    public function execute(int $assetId, string $cveId, int $userId): void
    {
        $asset = $this->assetRepository->findByUser($assetId, $userId);

        if (is_null($asset)) {
            throw new ModelNotFoundException('Asset not found');
        }

        $vulnerability = $this->vulnerabilityRepository->findByCve($cveId);

        if (is_null($vulnerability)) {
            throw new ModelNotFoundException('Vulnerability not found');
        }

        $this->attachOrDetach($assetId, $vulnerability->id);

        VulnerabilityRelatedToAsset::dispatch($vulnerability, $asset);
    }

    abstract function attachOrDetach(int $assetId, int $vulnerabilityId): void;
}
