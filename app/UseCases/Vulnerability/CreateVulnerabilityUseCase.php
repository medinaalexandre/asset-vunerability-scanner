<?php

namespace App\UseCases\Vulnerability;

use App\Dto\VulnerabilityDto;
use App\Events\VulnerabilityCreated;
use App\Exceptions\VulnerabilityAlreadyExistsException;
use App\Models\Vulnerability;
use App\Repositories\Contracts\VulnerabilityRepositoryInterface;

class CreateVulnerabilityUseCase
{
    public function __construct(
        protected readonly VulnerabilityRepositoryInterface $repository,
    ) {
    }

    /**
     * @throws VulnerabilityAlreadyExistsException
     */
    public function execute(VulnerabilityDto $dto): Vulnerability
    {
        if ($this->repository->findByCve($dto->cveId)) {
            throw new VulnerabilityAlreadyExistsException();
        }

        $vulnerability = $this->repository->create($dto);

        VulnerabilityCreated::dispatch($vulnerability->cve_id, $vulnerability->id);

        return $vulnerability;
    }
}
