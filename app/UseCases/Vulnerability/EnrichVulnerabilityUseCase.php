<?php

namespace App\UseCases\Vulnerability;

use App\Dto\CveDetailsDto;
use App\Enums\VulnerabilitySeverityEnum;
use App\Exceptions\CveIdNotFoundException;
use App\Exceptions\InvalidApiResponseException;
use App\Models\Vulnerability;
use App\Repositories\Contracts\VulnerabilityRepositoryInterface;
use App\Services\Contracts\EnrichCveDetailsServiceInterface;
use Carbon\Carbon;
use GuzzleHttp\Exception\GuzzleException;

class EnrichVulnerabilityUseCase
{
    public function __construct(
        protected readonly EnrichCveDetailsServiceInterface $apiService,
        protected readonly VulnerabilityRepositoryInterface $vulnerabilityRepository,
    ) {
    }

    /**
     * @throws GuzzleException
     * @throws InvalidApiResponseException
     */
    public function execute(Vulnerability $vulnerability): void
    {
        try {
            $details = $this->apiService->getDetails($vulnerability->cve_id);
        } catch (CveIdNotFoundException $e) {
            $this->vulnerabilityRepository->update(
                id: $vulnerability->id,
                severity: VulnerabilitySeverityEnum::UNKNOWN,
                description: $e->getMessage(),
                publishedAt: Carbon::now()
            );
        }

        $this->vulnerabilityRepository->update(
            id: $vulnerability->id,
            severity: $this->getHighestSeverity($details),
            description: $details->description,
            publishedAt: Carbon::make($vulnerability->published_at)
        );
    }

    protected function getHighestSeverity(CveDetailsDto $cveDetailsDto): VulnerabilitySeverityEnum
    {
        $priorityMap = VulnerabilitySeverityEnum::getPriorityMap();

        $severities = collect($cveDetailsDto->metrics)
            ->pluck('baseSeverity')
            ->map(fn (string $severity) => strtolower($severity));

        $highestSeverityString = $severities
            ->sortBy(fn (string $severity) => $priorityMap[$severity] ?? $priorityMap[VulnerabilitySeverityEnum::UNKNOWN->value])
            ->first();

        if ($highestSeverityString) {
            return VulnerabilitySeverityEnum::from($highestSeverityString);
        }

        return VulnerabilitySeverityEnum::UNKNOWN;
    }
}
