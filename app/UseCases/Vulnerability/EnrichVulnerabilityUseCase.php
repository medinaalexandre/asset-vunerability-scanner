<?php

namespace App\UseCases\Vulnerability;

use App\Dto\CveDetailsDto;
use App\Enums\VulnerabilitySeverityEnum;
use App\Exceptions\CveIdNotFoundException;
use App\Exceptions\InvalidApiResponseException;
use App\Repositories\Contracts\VulnerabilityDetailRepositoryInterface;
use App\Repositories\Contracts\VulnerabilityRepositoryInterface;
use App\Services\Contracts\EnrichCveDetailsServiceInterface;
use Carbon\Carbon;
use ChaseConey\LaravelDatadogHelper\Datadog;
use GuzzleHttp\Exception\GuzzleException;
use Illuminate\Database\Eloquent\ModelNotFoundException;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Throwable;

readonly class EnrichVulnerabilityUseCase
{
    public function __construct(
        protected EnrichCveDetailsServiceInterface $apiService,
        protected VulnerabilityRepositoryInterface $vulnerabilityRepository,
        protected VulnerabilityDetailRepositoryInterface $detailsRepository,
    ) {
    }

    /**
     * @throws GuzzleException
     * @throws InvalidApiResponseException
     * @throws Throwable
     */
    public function execute(int $vulnerabilityId): void
    {
        $vulnerability = $this->vulnerabilityRepository->find($vulnerabilityId);

        if (is_null($vulnerability)) {
            throw new ModelNotFoundException("Vulnerability with ID $vulnerabilityId not found");
        }

        try {
            $details = $this->apiService->getDetails($vulnerability->cve_id);
        } catch (CveIdNotFoundException $e) {
            $this->vulnerabilityRepository->update(
                id: $vulnerability->id,
                severity: VulnerabilitySeverityEnum::UNKNOWN,
                cvssBaseScore: 0.0,
                description: $e->getMessage(),
                publishedAt: Carbon::now()
            );
            return;
        }

        try {
            DB::beginTransaction();
            $this->vulnerabilityRepository->update(
                id: $vulnerability->id,
                severity: $this->getHighestSeverity($details),
                cvssBaseScore: $this->getBaseScoreForRisk($details),
                description: $details->description,
                publishedAt: Carbon::make($details->publishedAt),
            );

            foreach ($details->metrics as $metric) {
                $this->detailsRepository->upsert($vulnerability->id, $metric);
            }
            DB::commit();
        } catch (Throwable $exception) {
            DB::rollBack();
            Log::error("Failed to Enrich Vulnerability " . $exception->getMessage(), [
                'trace' => array_slice($exception->getTrace(), 0, 10),
                'code' => $exception->getCode(),
                'vulnerabilityId' => $vulnerability->id,
                'dto' => $details
            ]);
            throw $exception;
        }
    }

    protected function getHighestSeverity(CveDetailsDto $cveDetailsDto): VulnerabilitySeverityEnum
    {
        $priorityMap = VulnerabilitySeverityEnum::getPriorityMap();

        $severities = collect($cveDetailsDto->metrics)
            ->pluck('baseSeverity')
            ->map(fn (string $severity) => strtolower($severity));

        $highestSeverityString = $severities
            ->sortBy(fn (string $severity) => $priorityMap[$severity] ?? $priorityMap[VulnerabilitySeverityEnum::UNKNOWN->value])
            ->first();

        if ($highestSeverityString) {
            return VulnerabilitySeverityEnum::from($highestSeverityString);
        }

        return VulnerabilitySeverityEnum::UNKNOWN;
    }

    protected function getBaseScoreForRisk(CveDetailsDto $cveDetailsDto): float
    {
        $scores = collect($cveDetailsDto->metrics)
            ->map(function ($metric) {
                return [
                    'score' => $metric->baseScore,
                    'version' => $metric->version,
                ];
            });

        $v31MaxScore = $scores
            ->where('version', '3.1')
            ->max('score');

        if ($v31MaxScore) {
            return (float) $v31MaxScore;
        }

        return (float) ($scores->max('score') ?? 0.0);
    }
}
