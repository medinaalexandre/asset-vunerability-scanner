<?php

namespace App\Listeners;

use App\Events\VulnerabilityEnriched;
use App\Repositories\Contracts\VulnerabilityFactsRepositoryInterface;
use App\Repositories\Contracts\VulnerabilityRepositoryInterface;
use Illuminate\Contracts\Queue\ShouldQueue;

class RecordVulnerabilityFact implements ShouldQueue
{
    public function __construct(
        protected VulnerabilityRepositoryInterface $vulnerabilityRepository,
        protected VulnerabilityFactsRepositoryInterface $vulnerabilityFactsRepository
    ) {
    }

    public function handle(VulnerabilityEnriched $event): void
    {
        $vulnerability = $this->vulnerabilityRepository->find($event->vulnerabilityId);

        if (is_null($vulnerability)) {
            return;
        }

        $this->vulnerabilityFactsRepository->upsertVulnerabilityFacts($vulnerability);
    }
}
