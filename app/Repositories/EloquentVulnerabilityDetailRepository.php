<?php

namespace App\Repositories;


use App\Dto\CveDetailsMetricDto;
use App\Models\VulnerabilityDetail;
use App\Repositories\Contracts\VulnerabilityDetailRepositoryInterface;
use Illuminate\Database\Eloquent\Builder;

class EloquentVulnerabilityDetailRepository implements VulnerabilityDetailRepositoryInterface
{
    public function __construct(protected VulnerabilityDetail $model)
    {
    }

    /** @return Builder<VulnerabilityDetail> */
    protected function newQuery(): Builder
    {
        return $this->model->newQuery();
    }

    public function upsert(
        int $vulnerabilityId,
        CveDetailsMetricDto $metric
    ): VulnerabilityDetail {
        return $this->newQuery()->updateOrCreate(
            [
                'vulnerability_id' => $vulnerabilityId,
                'cvss_version' => $metric->cvssVersionSource,
                'source_name' => $metric->source,
            ],
            [
                'base_score' => $metric->baseScore,
                'base_severity' => $metric->baseSeverity,
                'vector' => $metric->vector,
                'raw_data' => json_encode($metric, JSON_THROW_ON_ERROR),
            ]
        );
    }
}
