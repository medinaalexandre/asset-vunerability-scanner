<?php

namespace App\Repositories;

use App\Dto\CalculatedAssetRisk;
use App\Helpers\DatadogCollectMetricHelper;
use App\Models\Asset;
use App\Models\Vulnerability;
use App\Models\VulnerabilityFact;
use App\Repositories\Contracts\VulnerabilityFactsRepositoryInterface;
use Carbon\Carbon;
use Illuminate\Support\Facades\Log;
use PhpClickHouseLaravel\RawColumn;

class ClickHouseVulnerabilityFactsRepository implements VulnerabilityFactsRepositoryInterface
{
    public function upsertVulnerabilityFacts(Vulnerability $vulnerability): void
    {
        $vulnerability->loadMissing('assets');

        if ($vulnerability->assets->isEmpty()) {
            return;
        }

        $facts = [];

        foreach ($vulnerability->assets as $asset) {
            $facts[] = $this->prepareData($asset, $vulnerability);
        }

        $startTime = microtime(true);
        VulnerabilityFact::prepareAndInsertBulk($facts);
        DatadogCollectMetricHelper::registerTimeSpent('clickhouse_vuln_fact_bulk_insert', $startTime);
    }

    public function upsertVulnerabilityAssetFact(Asset $asset, Vulnerability $vulnerability): void
    {
        $startTime = microtime(true);
        VulnerabilityFact::create($this->prepareData($asset, $vulnerability));
        DatadogCollectMetricHelper::registerTimeSpent('clickhouse_vuln_fact_single_insert', $startTime);
    }

    private function prepareData(Asset $asset, Vulnerability $vulnerability): array
    {
        return [
            'asset_id' => $asset->id,
            'cve_id' => $vulnerability->cve_id,
            'asset_criticality' => $asset->criticality_level?->value,
            'asset_weight' => $asset->criticality_level->getWeight(),
            'cvss_base_score' => $vulnerability->cvss_base_score,
            'calculated_severity' => $vulnerability->severity?->value,
            'published_at' => $vulnerability->published_at,
            'updated_at' => Carbon::now()->toDateTimeString(),
        ];
    }

    public function getCalculatedRiskForAsset(int $assetId): CalculatedAssetRisk
    {
        Log::info("Starting calculation risk for asset $assetId");
        $startTime = microtime(true);
        $calculatedData = VulnerabilityFact::select([
            'asset_id',
            new RawColumn('max(cvss_base_score)', 'max_cve_score'),
            new RawColumn('any(asset_weight)', 'asset_weight_factor'),
            new RawColumn('max(cvss_base_score) * any(asset_weight)', 'total_weighted_risk_score')
        ])
            ->where('asset_id', '=', $assetId)
            ->groupBy('asset_id')
            ->getRows();

        DatadogCollectMetricHelper::registerTimeSpent('clickhouse_calculate_asset_risk', $startTime);

        if (empty($calculatedData)) {
            return new CalculatedAssetRisk(
                assetId: $assetId,
                calculatedRisk: 0,
                maxCveScore: 0,
                assetWeightFactor: 0,
            );
        }

        $calculatedData = $calculatedData[0];

        return new CalculatedAssetRisk(
            assetId: $assetId,
            calculatedRisk: round($calculatedData['total_weighted_risk_score'], 2),
            maxCveScore: $calculatedData['max_cve_score'],
            assetWeightFactor: $calculatedData['asset_weight_factor'],
        );
    }
}
