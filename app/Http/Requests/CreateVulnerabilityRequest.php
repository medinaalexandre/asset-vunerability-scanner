<?php

namespace App\Http\Requests;

use App\Dto\VulnerabilityDto;
use App\Enums\VulnerabilitySeverityEnum;
use Carbon\Carbon;
use Illuminate\Foundation\Http\FormRequest;
use Illuminate\Support\Str;
use Illuminate\Validation\Rule;

class CreateVulnerabilityRequest extends FormRequest
{
    public function prepareForValidation(): void
    {
        $this->merge([
            'severity' => Str::lower($this->get('severity')),
        ]);
    }

    public function rules(): array
    {
        return [
            'cve_id' => 'required|string|max:255',
            'severity' => ['required', Rule::enum(VulnerabilitySeverityEnum::class)],
            'description' => 'string',
            'published_at' => 'date',
        ];
    }

    public function toDto(): VulnerabilityDto
    {
        return new VulnerabilityDto(
            cveId: $this->get('cve_id'),
            severity: VulnerabilitySeverityEnum::from($this->get('severity')),
            description: $this->get('description'),
            publishedAt: Carbon::make($this->get('published_at')),
        );
    }
}
