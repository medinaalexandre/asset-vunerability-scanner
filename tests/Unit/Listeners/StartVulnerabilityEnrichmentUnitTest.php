<?php

use App\Events\VulnerabilityCreated;
use App\Jobs\EnrichVulnerabilityDetailsJob;
use App\Listeners\StartVulnerabilityEnrichment;
use Illuminate\Support\Facades\Queue;

it('should dispatch EnrichVulnerabilityDetailsJob job', function () {
    Queue::fake();

    $listener = new StartVulnerabilityEnrichment();
    $cveId = 'CVE-2025-0001';
    $listener->handle(new VulnerabilityCreated($cveId, 1));

    Queue::assertPushed(
        EnrichVulnerabilityDetailsJob::class,
        static fn (EnrichVulnerabilityDetailsJob $job) => $job->cveId === $cveId && $job->vulnerabilityId === 1
    );
});
