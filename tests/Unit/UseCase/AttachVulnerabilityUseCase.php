<?php

use App\Models\Asset;
use App\Models\Vulnerability;
use App\Repositories\Contracts\AssetRepositoryInterface;
use App\Repositories\Contracts\VulnerabilityRepositoryInterface;
use App\UseCases\Asset\AttachVulnerabilityUseCase;
use Illuminate\Database\Eloquent\ModelNotFoundException;

beforeEach(function () {
    $this->assetRepositoryMock = Mockery::mock(AssetRepositoryInterface::class);
    $this->vulnerabilityRepositoryMock = Mockery::mock(VulnerabilityRepositoryInterface::class);
    $this->useCase = new AttachVulnerabilityUseCase($this->assetRepositoryMock, $this->vulnerabilityRepositoryMock);
});

it('can attach vulnerability to an asset', function () {
    $asset = new Asset();
    $this->assetRepositoryMock->shouldReceive('find')->with(1)->andReturn($asset);
    $this->vulnerabilityRepositoryMock->shouldReceive('find')->with(1)->andReturn(new Vulnerability());

    $this->assetRepositoryMock->shouldReceive('attachVulnerability')->with($asset, 1)->once()->andReturn();

    $this->useCase->execute(
        assetId: 1,
        vulnerabilityId: 1
    );
});

it('should throw exception if asset does not exist', function () {
    $this->assetRepositoryMock->shouldReceive('find')->with(1)->andReturn(null);
    $this->useCase->execute(1,1);
})->throws(ModelNotFoundException::class, 'Asset not found');

it('should throw exception if vulnerability does not exist', function () {
    $this->assetRepositoryMock->shouldReceive('find')->with(1)->andReturn(new Asset());
    $this->vulnerabilityRepositoryMock->shouldReceive('find')->with(1)->andReturn(null);
    $this->useCase->execute(1,1);
})->throws(ModelNotFoundException::class, 'Vulnerability not found');
