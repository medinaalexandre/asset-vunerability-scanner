<?php

use App\Dto\VulnerabilityDto;
use App\Events\VulnerabilityCreated;
use App\Models\Vulnerability;
use App\Repositories\Contracts\VulnerabilityRepositoryInterface;
use App\UseCases\Vulnerability\CreateVulnerabilityUseCase;
use Illuminate\Support\Facades\Event;
use Illuminate\Support\Facades\Queue;

beforeEach(function () {
    $this->repositoryMock = Mockery::mock(VulnerabilityRepositoryInterface::class);
    $this->useCase = new CreateVulnerabilityUseCase($this->repositoryMock);
});

it('should dispatch VulnerabilityCreated event and push the listener to the queue', function () {
    Event::fake();
    Queue::fake();

    $cveId = 'CVE-2025-0001';
    $vulnerabilityId = 42;
    $dto = new VulnerabilityDto(cveId: $cveId);

    $vulnerability = new Vulnerability();
    $vulnerability->id = $vulnerabilityId;
    $vulnerability->cve_id = $cveId;

    $this->repositoryMock->shouldReceive('findByCve')
        ->with($cveId)
        ->once()
        ->andReturnNull();

    $this->repositoryMock->shouldReceive('create')
        ->with($dto)
        ->once()
        ->andReturn($vulnerability);

    $this->useCase->execute($dto);

    Event::assertDispatched(
        VulnerabilityCreated::class,
        static fn ($event) => $event->cveId === $cveId && $event->vulnerabilityId === $vulnerabilityId
    );
});
