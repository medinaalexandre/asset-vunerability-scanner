<?php

use App\Models\Asset;
use App\Models\Vulnerability;
use App\Repositories\Contracts\AssetRepositoryInterface;
use App\Repositories\Contracts\VulnerabilityRepositoryInterface;
use App\UseCases\Asset\AttachVulnerabilityUseCase;
use Illuminate\Database\Eloquent\ModelNotFoundException;
use Illuminate\Support\Facades\Queue;

beforeEach(function () {
    $this->assetRepositoryMock = Mockery::mock(AssetRepositoryInterface::class);
    $this->vulnerabilityRepositoryMock = Mockery::mock(VulnerabilityRepositoryInterface::class);
    $this->useCase = new AttachVulnerabilityUseCase($this->assetRepositoryMock, $this->vulnerabilityRepositoryMock);
    Queue::fake();
});

it('can attach vulnerability to an asset', function () {
    $asset = new Asset();
    $asset->id = 1;
    $vulnerability = new Vulnerability();
    $vulnerability->id = 1;
    $this->assetRepositoryMock->shouldReceive('findByUser')->with(1, 1)->andReturn($asset);
    $this->vulnerabilityRepositoryMock->shouldReceive('findByCve')
        ->with('CVE-2025-0001')->andReturn($vulnerability);

    $this->assetRepositoryMock->shouldReceive('attachVulnerability')
        ->with($asset->id, $vulnerability->id)
        ->once()
        ->andReturn();

    $this->useCase->execute(
        assetId: 1,
        cveId: 'CVE-2025-0001',
        userId: 1
    );
});

it('should throw exception if asset does not exist', function () {
    $this->assetRepositoryMock->shouldReceive('findByUser')->with(1,1)->andReturn(null);
    $this->useCase->execute(1,1, 1);
})->throws(ModelNotFoundException::class, 'Asset not found');

it('should throw exception if vulnerability does not exist', function () {
    $this->assetRepositoryMock->shouldReceive('findByUser')->with(1,1)->andReturn(new Asset());
    $this->vulnerabilityRepositoryMock->shouldReceive('findByCve')->with('CVE-2025-0001')->andReturn(null);
    $this->useCase->execute(1,'CVE-2025-0001', 1);
})->throws(ModelNotFoundException::class, 'Vulnerability not found');
