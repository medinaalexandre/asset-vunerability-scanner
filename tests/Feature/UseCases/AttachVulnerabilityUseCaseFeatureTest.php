<?php

use App\Models\Asset;
use App\Models\User;
use App\Models\Vulnerability;
use App\Repositories\EloquentAssetRepository;
use App\Repositories\EloquentVulnerabilityRepository;
use App\UseCases\Asset\AttachVulnerabilityUseCase;
use Illuminate\Database\Eloquent\ModelNotFoundException;

beforeEach(function () {
    $this->useCase = new AttachVulnerabilityUseCase(
        new EloquentAssetRepository(new Asset()),
        new EloquentVulnerabilityRepository(new Vulnerability()),
    );
});

it('can attach a vulnerability to a asset', function () {
    $asset = Asset::factory()->create();
    $vulnerability = Vulnerability::factory()->create();

    $this->useCase->execute($asset->getKey(), $vulnerability->cve_id, $asset->user_id);

    expect($asset->vulnerabilities()->count())->toBe(1)
        ->and($asset->vulnerabilities()->first()->id)->toBe($vulnerability->id);
});

it('cannot attach a vulnerability to a asset from another user', function () {
    $anotherUser = User::factory()->create();
    $asset = Asset::factory()->create();
    $vulnerability = Vulnerability::factory()->create();

    $this->useCase->execute($asset->getKey(), $vulnerability->cve_id, $anotherUser->id);
})->throws(ModelNotFoundException::class);
