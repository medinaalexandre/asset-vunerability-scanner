<?php

use App\Models\Asset;
use App\Models\User;
use App\Models\Vulnerability;
use App\Repositories\EloquentAssetRepository;
use App\Repositories\EloquentVulnerabilityRepository;
use App\UseCases\Asset\DetachVulnerabilityUseCase;
use Illuminate\Database\Eloquent\ModelNotFoundException;

beforeEach(function () {
    $this->useCase = new DetachVulnerabilityUseCase(
        new EloquentAssetRepository(new Asset()),
        new EloquentVulnerabilityRepository(new Vulnerability()),
    );
});

it('can attach a vulnerability to an asset', function () {
    $vulnerability = Vulnerability::factory()->create();
    $asset = Asset::factory()->hasAttached($vulnerability)->create();

    $this->useCase->execute($asset->getKey(), $vulnerability->cve_id, $asset->user_id);

    expect($asset->vulnerabilities()->count())->toBe(0);
});

it('cannot detach a vulnerability from an asset of another user', function () {
    $anotherUser = User::factory()->create();
    $vulnerability = Vulnerability::factory()->create();
    $asset = Asset::factory()->hasAttached($vulnerability)->create();

    $this->useCase->execute($asset->getKey(), $vulnerability->cve_id, $anotherUser->id);
})->throws(ModelNotFoundException::class);
