<?php

mutates(EloquentVulnerabilityRepository::class);

use App\Dto\VulnerabilityDto;
use App\Enums\VulnerabilitySeverityEnum;
use App\Exceptions\VulnerabilityAlreadyExistsException;
use App\Models\Vulnerability;
use App\Repositories\EloquentVulnerabilityRepository;
use Carbon\Carbon;

beforeEach(function () {
    $this->repo = new EloquentVulnerabilityRepository(new Vulnerability());
});

it('can create a new Vulnerability', function () {
    $dto = new VulnerabilityDto(
        cveId: 'CVE-2025-1234',
        severity: VulnerabilitySeverityEnum::MEDIUM,
        description: 'Foo bar vulnerability',
        publishedAt: Carbon::now()
    );

    $vulnerability = $this->repo->create($dto);

    expect($vulnerability)
        ->id->toBeInt()
        ->cve_id->toBe($dto->cveId)
        ->severity->toBe($dto->severity)
        ->description->toBe($dto->description);
});

it('throws an exception when creating a vulnerability with existing CVE ID', function () {
    $vulnerability = Vulnerability::factory()->create();

    $this->repo->create(new VulnerabilityDto(
        cveId: $vulnerability->cve_id,
        severity: VulnerabilitySeverityEnum::LOW,
        description: 'already exists',
        publishedAt: Carbon::now()
    ));
})->throws(VulnerabilityAlreadyExistsException::class);
