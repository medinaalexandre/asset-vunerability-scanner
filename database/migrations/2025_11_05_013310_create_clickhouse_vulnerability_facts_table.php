<?php

use PhpClickHouseLaravel\Migration;

return new class extends Migration
{
    public function up(): void
    {
        self::write(
            "
            CREATE TABLE IF NOT EXISTS vulnerability_facts
            (
                asset_id UInt64 NOT NULL,
                cve_id LowCardinality(String),
                asset_criticality LowCardinality(String),
                asset_weight UInt32 NOT NULL,
                cvss_base_score Float64,
                calculated_severity LowCardinality(String),
                published_at DateTime,
                updated_at DateTime DEFAULT now()
            )
            ENGINE = ReplacingMergeTree(updated_at)
            PARTITION BY toYYYYMM(created_at)
            ORDER BY (asset_id, cve_id, updated_at)
            PRIMARY KEY (asset_id, cve_id)
            "
        );
    }


    public function down(): void
    {
        self::write('DROP TABLE IF EXISTS vulnerability_facts');
    }
};
